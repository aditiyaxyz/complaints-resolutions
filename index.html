<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Complaint Management System</title>
<!-- Tailwind CSS (Correct Link) -->
<script src="https://www.google.com/search?q=https://cdn.tailwindcss.com"></script>

<!-- Google Font: Poppins -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
    /* Apply the new font */
    body, input, select, textarea, button {
        font-family: 'Poppins', sans-serif;
    }

    /* Custom styles for nav tabs */
    .nav-tab.active {
        @apply bg-indigo-600 text-white;
        /* This is the new "glow" */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 
                    0 4px 6px -4px rgba(0, 0, 0, 0.1), 
                    0 0 20px 5px rgba(99, 102, 241, 0.5); /* indigo-500 glow */
    }
    
    /* Loading spinner */
    .loader {
        border: 4px solid #f3f3f3; /* Light grey */
        border-top: 4px solid #6366f1; /* Indigo */
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Animated Gradient Header */
    .gradient-breathe {
        background: linear-gradient(-45deg, #6366f1, #8b5cf6, #a855f7);
        background-size: 400% 400%;
        animation: gradientBreathe 15s ease infinite;
    }
    @keyframes gradientBreathe {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    
    /* Custom thin scrollbar */
    ::-webkit-scrollbar {
        width: 6px;
    }
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
        background: #c5c5c5;
        border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* Animation for form fields */
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .form-field {
        animation: slideInUp 0.5s ease-out forwards;
        opacity: 0;
    }

    /* View transition */
    .view {
        animation: slideInUp 0.3s ease-out;
    }
</style>


</head>
<body class="bg-gray-50 font-sans">

<!-- Alert Message Box -->
<div id="alertBox" class="hidden fixed top-5 right-5 z-50 max-w-sm">
    <div id="alertContent" class="flex items-center p-4 rounded-lg shadow-lg" role="alert">
        <svg id="alertIcon" class="flex-shrink-0 w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
        <div id="alertMessage" class="ml-3 text-sm font-medium"></div>
        <button id="alertClose" type="button" class="ml-auto -mx-1.5 -my-1.5 rounded-lg p-1.5 inline-flex h-8 w-8" aria-label="Close">
            <span class="sr-only">Close</span>
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
    </div>
</div>

<!-- Main Content -->
<div class="container mx-auto max-w-4xl p-4 md:p-8">
    
    <!-- Header -->
    <header class="text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-bold text-center gradient-breathe bg-clip-text text-transparent py-2">
            Complaint Management System
        </h1>
        <p class="text-lg text-gray-600 mt-2">Submit a new complaint or track an existing one.</p>
    </header>

    <!-- Navigation Tabs -->
    <div class="mb-8">
        <!-- This is the new floating card for the navigation -->
        <div class="bg-white p-4 rounded-xl shadow-lg flex justify-center items-center gap-6">
            <button id="navSubmit" class="nav-tab py-3 px-6 font-semibold text-center text-gray-700 bg-white rounded-full shadow-md cursor-pointer flex items-center gap-2 transition duration-300 ease-in-out hover:transform hover:-translate-y-1 hover:shadow-xl" data-view="submitView">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0L8 7.236l-4.243 4.243a2 2 0 11-2.828-2.828l7-7a2 2 0 012.828 0l3 3z" /><path d="M4 14v3a2 2 0 002 2h10a2 2 0 002-2v-3l-4-4H8L4 14z" />
                </svg>
                New Complaint
            </button>
            <button id="navSearch" class="nav-tab py-3 px-6 font-semibold text-center text-gray-700 bg-white rounded-full shadow-md cursor-pointer flex items-center gap-2 transition duration-300 ease-in-out hover:transform hover:-translate-y-1 hover:shadow-xl" data-view="searchView">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
                Search & Resolve
            </button>
        </div>
    </div>

    <!-- Submit Complaint View -->
    <div id="submitView" class="view bg-white p-6 md:p-8 rounded-xl shadow-xl">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Submit a New Complaint</h2>
        <form id="complaintForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-field" style="animation-delay: 100ms;">
                    <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="name" name="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm transition duration-300 ease-in-out focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 focus:shadow-inner">
                </div>
                <div class="form-field" style="animation-delay: 200ms;">
                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                    <input type="tel" id="phone" name="phone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm transition duration-300 ease-in-out focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 focus:shadow-inner">
                </div>
                <div class="form-field" style="animation-delay: 300ms;">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="email" name="email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm transition duration-300 ease-in-out focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 focus:shadow-inner">
                </div>
                <div class="form-field" style="animation-delay: 400ms;">
                    <label for="priority" class="block text-sm font-medium text-gray-700">Priority</label>
                    <select id="priority" name="priority" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm transition duration-300 ease-in-out focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 focus:shadow-inner bg-white">
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                        <option value="Urgent">Urgent</option>
                    </select>
                </div>
            </div>

            <div class="form-field" style="animation-delay: 500ms;">
                <label for="location" class="block text-sm font-medium text-gray-700">Location</label>
                <input type="text" id="location" name="location" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm transition duration-300 ease-in-out focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 focus:shadow-inner">
            </div>

            <div class="form-field" style="animation-delay: 600ms;">
                <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="description" name="description" rows="4" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm transition duration-300 ease-in-out focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 focus:shadow-inner"></textarea>
            </div>

            <div class="form-field" style="animation-delay: 700ms;">
                <label for="complaintImage" class="block text-sm font-medium text-gray-700">Upload Image (Optional)</label>
                <input type="file" id="complaintImage" name="complaintImage" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition duration-300 ease-in-out">
            </div>

            <div class="text-right form-field" style="animation-delay: 800ms;">
                <button id="submitButton" type="submit" class="transition duration-300 ease-in-out hover:transform hover:-translate-y-0.5 hover:shadow-lg inline-flex items-center justify-center py-2 px-6 border border-transparent shadow-md text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    <span id="submitButtonText">Submit Complaint</span>
                    <span id="submitButtonLoader" class="hidden"><div class="loader"></div></span>
                </button>
            </div>
        </form>
    </div>

    <!-- Search & Resolve View -->
    <div id="searchView" class="view bg-white p-6 md:p-8 rounded-xl shadow-xl" style="display: none;">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Search & Resolve Complaint</h2>
        
        <!-- Search Bar -->
        <div class="flex mb-6">
            <input type="text" id="searchInput" placeholder="Enter Complaint Number (e.g., COMP-1234)..." class="flex-grow rounded-l-md border-gray-300 shadow-sm !mt-0 block w-full transition duration-300 ease-in-out focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 focus:shadow-inner">
            <button id="searchButton" class="transition duration-300 ease-in-out hover:transform hover:-translate-y-0.5 hover:shadow-lg py-2 px-5 bg-indigo-600 text-white font-semibold rounded-r-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                <span id="searchButtonText">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                </span>
                <span id="searchButtonLoader" class="hidden"><div class="loader"></div></span>
            </button>
        </div>

        <!-- Search Result / Resolution Form -->
        <div id="searchResult" class="space-y-6">
            <!-- Content will be injected by JavaScript -->
        </div>
    </div>

</div>

<!-- Firebase SDKs -->
<script type="module">
    // Import the functions you need from the SDKs you need
    // THIS SECTION IS NOW UPDATED FOR YOUR PERSONAL FIREBASE PROJECT
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        setDoc, 
        getDoc, 
        collection, 
        serverTimestamp, 
        updateDoc 
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { 
        getStorage, 
        ref, 
        uploadBytes, 
        getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

    // --- Firebase Configuration ---
    // This is YOUR personal config that you provided.
    const firebaseConfig = {
        apiKey: "AIzaSyD6HrjH7EEiftlcUnwGIO1lKTiaI5VJTd0",
        authDomain: "complain-d60e7.firebaseapp.com",
        projectId: "complain-d60e7",
        storageBucket: "complain-d60e7.firebasestorage.app",
        messagingSenderId: "107931208060",
        appId: "1:107931208060:web:79d61f1a49aff62c52bcf9",
        measurementId: "G-MYHX481S8Y"
    };

    let db, auth, storage, userId;

    // --- App Initialization ---
    try {
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); // Initialize Analytics
        
        db = getFirestore(app);
        auth = getAuth(app);
        storage = getStorage(app);

        // Sign in the user anonymously
        // We removed the platform-specific token logic
        await signInAnonymously(auth);
        
        userId = auth.currentUser?.uid || `anon-${Math.random().toString(36).substring(2, 10)}`;
        
    } catch (error) {
        console.error("Firebase Initialization Error:", error);
        showAlert(`Failed to initialize app: ${error.message}`, 'error');
    }

    // --- DOM Element References ---
    const navSubmit = document.getElementById('navSubmit');
    const navSearch = document.getElementById('navSearch');
    const submitView = document.getElementById('submitView');
    const searchView = document.getElementById('searchView');
    
    const complaintForm = document.getElementById('complaintForm');
    const submitButton = document.getElementById('submitButton');
    const submitButtonText = document.getElementById('submitButtonText');
    const submitButtonLoader = document.getElementById('submitButtonLoader');

    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const searchButtonText = document.getElementById('searchButtonText');
    const searchButtonLoader = document.getElementById('searchButtonLoader');
    const searchResult = document.getElementById('searchResult');

    const alertBox = document.getElementById('alertBox');
    const alertContent = document.getElementById('alertContent');
    const alertIcon = document.getElementById('alertIcon');
    const alertMessage = document.getElementById('alertMessage');
    const alertClose = document.getElementById('alertClose');

    // --- Navigation Logic ---
    function switchView(viewId) {
        // Hide all views
        document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
        
        // Show the target view
        const activeView = document.getElementById(viewId);
        if (activeView) {
            activeView.style.display = 'block';
        }

        // Update tab active state
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });

        if (viewId === 'submitView') {
            navSubmit.classList.add('active');
        } else if (viewId === 'searchView') {
            navSearch.classList.add('active');
        }
    }

    navSubmit.addEventListener('click', () => switchView('submitView'));
    navSearch.addEventListener('click', () => switchView('searchView'));
    
    // --- Alert Box Logic ---
    const alertIcons = {
        success: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>',
        error: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>',
        info: '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>'
    };
    const alertColors = {
        success: { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-300' },
        error: { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-300' },
        info: { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-300' }
    };

    function showAlert(message, type = 'info') {
        const colors = alertColors[type];
        alertContent.className = `flex items-center p-4 rounded-lg shadow-lg ${colors.bg} ${colors.text} border-t-4 ${colors.border}`;
        alertIcon.innerHTML = alertIcons[type];
        alertMessage.textContent = message;
        alertBox.classList.remove('hidden');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            alertBox.classList.add('hidden');
        }, 5000);
    }
    alertClose.addEventListener('click', () => alertBox.classList.add('hidden'));

    // --- Helper: Toggle Button Loading State ---
    function toggleLoading(button, textEl, loaderEl, isLoading) {
        if (isLoading) {
            button.disabled = true;
            textEl.classList.add('hidden');
            loaderEl.classList.remove('hidden');
        } else {
            button.disabled = false;
            textEl.classList.remove('hidden');
            loaderEl.classList.add('hidden');
        }
    }

    // --- Helper: Upload File ---
    async function uploadFile(file, path) {
        if (!file) return null;
        
        // Simplified path for your own project
        const storageRef = ref(storage, `${path}/${userId}_${Date.now()}_${file.name}`);
        
        try {
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            return downloadURL;
        } catch (error) {
            console.error("File Upload Error:", error);
            showAlert(`Failed to upload image: ${error.message}`, 'error');
            return null;
        }
    }

    // --- NEW: Generate Readable ID ---
    async function generateReadableId() {
        const prefix = "COMP";
        // Simplified collection path for your own project
        const collectionRef = collection(db, "complaints");
        let newId = "";
        let isUnique = false;

        while (!isUnique) {
            const randomNum = Math.floor(1000 + Math.random() * 9000); // 4 digits
            newId = `${prefix}-${randomNum}`;
            
            const docRef = doc(collectionRef, newId);
            const docSnap = await getDoc(docRef);
            
            if (!docSnap.exists()) {
                isUnique = true;
            }
        }
        return newId;
    }

    // --- Complaint Submission Logic (MODIFIED) ---
    complaintForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        toggleLoading(submitButton, submitButtonText, submitButtonLoader, true);
        
        const formData = new FormData(complaintForm);
        const file = formData.get('complaintImage');
        let imageUrl = null;

        if (file && file.size > 0) {
            imageUrl = await uploadFile(file, 'complaint_images');
            if (!imageUrl) {
                toggleLoading(submitButton, submitButtonText, submitButtonLoader, false);
                return; 
            }
        }
        
        try {
            const newComplaintId = await generateReadableId();
            
            // Simplified collection path
            const docRef = doc(db, "complaints", newComplaintId);

            await setDoc(docRef, {
                name: formData.get('name'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                priority: formData.get('priority'),
                location: formData.get('location'),
                description: formData.get('description'),
                imageUrl: imageUrl,
                status: 'Pending',
                submittedAt: serverTimestamp(),
                submitterUid: userId,
                readableId: newComplaintId
            });
            
            showAlert(`Complaint submitted! Your Complaint Number is: ${newComplaintId}`, 'success');
            complaintForm.reset();
            
        } catch (error) {
            console.error("Error adding document: ", error);
            showAlert(`Error: ${error.message}`, 'error');
        } finally {
            toggleLoading(submitButton, submitButtonText, submitButtonLoader, false);
        }
    });

    // --- Complaint Search Logic (MODIFIED & FIXED) ---
    searchButton.addEventListener('click', async () => {
        const complaintId = searchInput.value.trim().toUpperCase();
        if (!complaintId) {
            showAlert('Please enter a Complaint Number.', 'info');
            return;
        }
        
        toggleLoading(searchButton, searchButtonText, searchButtonLoader, true);
        searchResult.innerHTML = ''; 
        
        try {
            // Simplified doc path
            const docRef = doc(db, "complaints", complaintId);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                displayComplaintDetails(docSnap.data(), complaintId);
            } else {
                showAlert('No complaint found with that ID.', 'error');
            }
            
        } catch (error) { // <-- The 'S' typo is GONE
            console.error("Error fetching document:", error);
            showAlert(`Error: ${error.message}`, 'error');
        } finally {
            toggleLoading(searchButton, searchButtonText, searchButtonLoader, false);
        }
    });

    // --- Display Search Result ---
    function displayComplaintDetails(data, id) {
        const submittedAt = data.submittedAt?.toDate().toLocaleString() || 'N/A';
        const statusClass = data.status === 'Pending' ? 'text-orange-500' : 'text-green-600';
        
        let detailsHtml = `
            <div class="border rounded-lg p-4 bg-gray-50 space-y-4">
                <h3 class="text-xl font-semibold">Complaint Details (ID: ${id})</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><strong>Status:</strong> <span class="${statusClass} font-bold">${data.status}</span></div>
                    <div><strong>Priority:</strong> ${data.priority}</div>
                    <div><strong>Submitted At:</strong> ${submittedAt}</div>
                    <div><strong>Submitted By:</strong> ${data.name} (${data.email})</div>
                    <div><strong>Phone:</strong> ${data.phone}</div>
                    <div><strong>Location:</strong> ${data.location}</div>
                </div>
                <div class="pt-2">
                    <strong class="block mb-1">Description:</strong>
                    <p class="bg-white p-3 rounded-md border">${data.description || 'N/A'}</p>
                </div>
        `;
        
        if (data.imageUrl) {
            detailsHtml += `
                <div class="pt-2">
                    <strong class="block mb-1">Submitted Image:</strong>
                    <img src="${data.imageUrl}" alt="Complaint Image" class="rounded-md border max-h-60 w-auto">
                </div>
            `;
        }

        if (data.status === 'Resolved') {
            const resolvedAt = data.resolvedAt?.toDate().toLocaleString() || 'N/A';
            detailsHtml += `
                    <hr class="my-4">
                    <h4 class="text-lg font-semibold text-green-700">Resolution Details</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><strong>Resolved At:</strong> ${resolvedAt}</div>
                        <div><strong>Resolved By:</strong> ${data.resolvedByName || 'N/A'} (${data.resolvedByPhone || 'N/A'})</div>
                    </div>
                    <div class="pt-2">
                        <strong class="block mb-1">Resolution Notes:</strong>
                        <p class="bg-white p-3 rounded-md border">${data.resolutionNotes || 'N/A'}</p>
                    </div>
            `;
            if (data.resolutionImageUrl) {
                detailsHtml += `
                    <div class="pt-2">
                        <strong class="block mb-1">Resolution Image:</strong>
                        <img src="${data.resolutionImageUrl}" alt="Resolution Image" class="rounded-md border max-h-60 w-auto">
                    </div>
                `;
            }
            detailsHtml += '</div>'; // Close border container
            
        } else {
            // Show Resolution Form
            detailsHtml += `
                </div> <!-- Close details border container -->
                <hr class="my-6">
                <h3 class="text-xl font-semibold">Resolve Complaint</h3>
                <form id="resolutionForm" class="space-y-4">
                    <div>
                        <label for="resolvedByName" class="block text-sm font-medium text-gray-700">Resolved by Name</label>
                        <input type="text" id="resolvedByName" name="resolvedByName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm transition duration-300 ease-in-out focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 focus:shadow-inner">
                    </div>
                    <div>
                        <label for="resolvedByPhone" class="block text-sm font-medium text-gray-700">Resolved by Phone</label>
                        <input type="tel" id="resolvedByPhone" name="resolvedByPhone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm transition duration-300 ease-in-out focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 focus:shadow-inner">
                    </div>
                    <div>
                        <label for="resolutionNotes" class="block text-sm font-medium text-gray-700">Resolution Notes</label>
                        <textarea id="resolutionNotes" rows="4" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm transition duration-300 ease-in-out focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 focus:shadow-inner"></textarea>
                    </div>
                    <div>
                        <label for="resolutionImage" class="block text-sm font-medium text-gray-700">Upload Resolution Image (Optional)</label>
                        <input type="file" id="resolutionImage" name="resolutionImage" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 transition duration-300 ease-in-out">
                    </div>
                    <div>
                        <label for="resolutionDate" class="block text-sm font-medium text-gray-700">Date & Time of Resolution</label>
                        <input type="datetime-local" id="resolutionDate" name="resolutionDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm transition duration-300 ease-in-out focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 focus:shadow-inner">
                    </div>
                    <div id="resolutionResponse" class="mt-4"></div>
                    <div class="text-right">
                        <button type="submit" id="resolveButton" class="transition duration-300 ease-in-out hover:transform hover:-translate-y-0.5 hover:shadow-lg inline-flex items-center justify-center py-2 px-6 border border-transparent shadow-md text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                            <span id="resolveButtonText">Mark as Resolved</span>
                            <span id="resolveButtonLoader" class="hidden"><div class="loader"></div></span>
                        </button>
                    </div>
                </form>
            `;
        }
        
        searchResult.innerHTML = detailsHtml;

        // Set default date/time for resolution
        if (document.getElementById('resolutionDate')) {
            document.getElementById('resolutionDate').value = new Date().toISOString().slice(0, 16);
        }
        
        // Add event listener to the new form
        if (document.getElementById('resolutionForm')) {
            document.getElementById('resolutionForm').addEventListener('submit', (e) => handleResolutionSubmit(e, id));
        }
    }
    
    // --- Handle Resolution Submission ---
    async function handleResolutionSubmit(e, complaintId) {
        e.preventDefault();
        
        const resolveButton = document.getElementById('resolveButton');
        const resolveButtonText = document.getElementById('resolveButtonText');
        const resolveButtonLoader = document.getElementById('resolveButtonLoader');
        toggleLoading(resolveButton, resolveButtonText, resolveButtonLoader, true);
        
        const resForm = new FormData(e.target);
        const resFile = resForm.get('resolutionImage');
        let resImageUrl = null;
        
        if (resFile && resFile.size > 0) {
            resImageUrl = await uploadFile(resFile, 'resolution_images');
            if (!resImageUrl) {
                toggleLoading(resolveButton, resolveButtonText, resolveButtonLoader, false);
                return; 
            }
        }
        
        const resolutionDate = new Date(resForm.get('resolutionDate'));

        try {
            // Simplified doc path
            const docRef = doc(db, "complaints", complaintId);
            
            await updateDoc(docRef, {
                status: 'Resolved',
                resolvedByName: resForm.get('resolvedByName'),
                resolvedByPhone: resForm.get('resolvedByPhone'),
                resolutionNotes: resForm.get('resolutionNotes'),
                resolutionImageUrl: resImageUrl,
                resolvedAt: resolutionDate // Use the selected date
            });
            
            showAlert('Complaint marked as resolved!', 'success');
            // Re-run the search to refresh the view
            searchButton.click();
            
        } catch (error) {
            console.error("Error updating document:", error);
            showAlert(`Error: ${error.message}`, 'error');
        } finally {
            toggleLoading(resolveButton, resolveButtonText, resolveButtonLoader, false);
        }
    }

    // --- Initial Setup ---
    // Set the 'New Complaint' tab as active by default
    switchView('submitView');

</script>


</body>
</html>
